{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "event.schema.json",
  "title": "Event",
  "type": "object",
  "oneOf": [
    {"$ref": "#/$defs/expense_event"},
    {"$ref": "#/$defs/lifelog_event"},
    {"$ref": "#/$defs/meal_event"},
    {"$ref": "#/$defs/mood_event"}
  ],
  "$defs": {
    "base": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "event_id",
        "type",
        "happened_at",
        "tags",
        "data",
        "source",
        "confidence",
        "created_at",
        "updated_at",
        "is_deleted"
      ],
      "properties": {
        "event_id": {"type": "integer", "minimum": 1},
        "type": {"type": "string"},
        "happened_at": {"type": "string", "format": "date-time"},
        "tags": {"type": "array", "items": {"type": "string"}, "maxItems": 20},
        "data": {"type": "object"},
        "source": {
          "type": "string",
          "enum": ["chat_text", "chat_image", "chat_voice", "import"]
        },
        "confidence": {"type": "number", "minimum": 0, "maximum": 1},
        "created_at": {"type": "string", "format": "date-time"},
        "updated_at": {"type": "string", "format": "date-time"},
        "is_deleted": {"type": "integer", "enum": [0, 1]}
      }
    },
    "expense_data": {
      "type": "object",
      "additionalProperties": false,
      "required": ["amount", "currency", "category", "note"],
      "properties": {
        "amount": {"type": "number", "exclusiveMinimum": 0},
        "currency": {"type": "string"},
        "category": {
          "type": "string",
          "enum": [
            "food",
            "transport",
            "shopping",
            "entertainment",
            "housing",
            "medical",
            "education",
            "other",
            "unknown"
          ]
        },
        "note": {"type": ["string", "null"]}
      }
    },
    "lifelog_data": {
      "type": "object",
      "additionalProperties": false,
      "required": ["text"],
      "properties": {
        "text": {"type": "string"}
      }
    },
    "meal_data": {
      "type": "object",
      "additionalProperties": false,
      "required": ["meal_type", "items"],
      "properties": {
        "meal_type": {
          "type": "string",
          "enum": ["breakfast", "lunch", "dinner", "snack", "unknown"]
        },
        "items": {"type": "array", "items": {"type": "string"}, "minItems": 1}
      }
    },
    "mood_data": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mood", "intensity", "topic", "note"],
      "properties": {
        "mood": {"type": "string"},
        "intensity": {"type": "number", "minimum": 0, "maximum": 1},
        "topic": {"type": ["string", "null"]},
        "note": {"type": ["string", "null"]}
      }
    },
    "expense_event": {
      "allOf": [
        {"$ref": "#/$defs/base"},
        {
          "type": "object",
          "properties": {
            "type": {"const": "expense"},
            "data": {"$ref": "#/$defs/expense_data"}
          }
        }
      ]
    },
    "lifelog_event": {
      "allOf": [
        {"$ref": "#/$defs/base"},
        {
          "type": "object",
          "properties": {
            "type": {"const": "lifelog"},
            "data": {"$ref": "#/$defs/lifelog_data"}
          }
        }
      ]
    },
    "meal_event": {
      "allOf": [
        {"$ref": "#/$defs/base"},
        {
          "type": "object",
          "properties": {
            "type": {"const": "meal"},
            "data": {"$ref": "#/$defs/meal_data"}
          }
        }
      ]
    },
    "mood_event": {
      "allOf": [
        {"$ref": "#/$defs/base"},
        {
          "type": "object",
          "properties": {
            "type": {"const": "mood"},
            "data": {"$ref": "#/$defs/mood_data"}
          }
        }
      ]
    }
  }
}
